# 多轮迭代式场景生成与优化流水线技术文档

## 摘要

本文档详细介绍了 `infer.py` 中实现的多轮迭代式场景生成流水线。该系统通过将大语言模型（LLM）的推理能力、视觉语言模型（VLM）的审美评估以及物理引擎的约束检查相结合，构建了一个闭环的场景优化系统。与传统的单次生成方法不同，该流水线允许模型在多轮对话中逐步完善场景，通过不断的“渲染-评估-修改”循环，最终生成既符合用户意图又具备物理合理性的高质量3D室内场景。

---

## 1. 系统架构与技术逻辑

### 1.1 初始场景脚手架 (Initial Scene Scaffolding)

流水线的第一步是根据用户文本需求生成初始的房间结构。
- **技术实现**：通过 `generate_empty_room_with_model` 或 `generate_empty_room` (Azure OpenAI) 生成。
- **逻辑抽象**：定义房间边界（Room Envelope）和功能分区（Functional Groups），但不包含具体物体。这为后续的迭代编辑提供了一个结构化的空间约束。

### 1.2 闭环迭代优化循环 (Closed-loop Iterative Refinement)

这是系统的核心逻辑，封装在 `iterative_scene_generation` 函数中。每一轮迭代包含以下四个关键环节：

#### A. 多模态反馈注入 (Multi-modal Feedback Injection)
系统不仅提供当前的场景 JSON，还注入了两种维度的反馈：
1.  **物理反馈 (Physics Feedback)**：利用 `TrimeshPhysicsMetrics` 检测物体间的碰撞（Collision）和出界（Out-of-Bounds）问题。
2.  **视觉布局反馈 (VLM Layout Feedback)**：利用 Azure GPT-4o 分析渲染图，从室内设计专家角度提出布局建议（如“沙发未靠墙”、“家具分布不均”）。

#### B. 基于工具调用的场景编辑 (Tool-based Manipulation)
模型通过输出结构化的 `<tool_calls>` 标签来执行具体操作：
- `add_object`: 添加新物体
- `move_object` / `rotate_object` / `scale_object`: 调整空间属性
- `replace_object`: 替换物体类型
- `remove_object`: 移除不合适物体
- `terminate`: 逻辑终止信号，表示场景已达最优

#### C. 资产检索与对齐 (Asset Retrieval & Alignment)
模型生成的物体描述是抽象的，系统通过 `AssetRetrievalModule` (3D-FUTURE) 和 `ObjaverseRetriever` 将其映射到真实的 3D 模型 ID（JID/UID），确保生成结果的可实现性。

#### D. 自动化渲染与可视化 (Automated Rendering)
使用 Blender 外部进程进行双视角渲染（俯视图 + 斜视图），并合成带标注的图像，作为下一轮迭代的视觉输入。

### 1.3 上下文与状态管理

- **对话历史管理**：通过 `MAX_HISTORY_TURNS` 限制上下文长度，防止显存溢出（OOM），同时保留关键的决策历史。
- **格式标准化**：在 `flat` (SSR) 和 `grouped` 格式之间动态转换，以兼顾模型推理的简洁性和物理评估的结构化需求。

---

## 2. 学术思考与设计哲学

### 2.1 闭环优化 vs. 单次生成 (Iterative vs. One-shot)

单次生成（One-shot）往往难以同时兼顾复杂的空间约束和审美细节。本流水线采用的迭代方法模拟了人类设计师的工作流程：**构思 -> 草图 -> 评审 -> 修改**。这种方法显著降低了模型在单次推理中的认知负荷，提高了复杂场景生成的成功率。

### 2.2 显式物理约束与隐式审美偏好的结合

系统将“硬约束”（物理碰撞、边界限制）通过确定性的算法（Trimesh）计算，而将“软约束”（布局美感、功能合理性）交给 VLM 评估。这种**符号化计算与神经网络推理的协同**，解决了纯神经模型难以处理精确空间关系的痛点。

### 2.3 视觉-语言-空间的三位一体对齐

流水线在三个维度上保持一致性：
1.  **语言层**：用户需求与模型推理。
2.  **视觉层**：Blender 渲染图提供的直观反馈。
3.  **空间层**：JSON 格式定义的精确坐标与尺寸。
通过多轮迭代，系统不断缩小这三个维度之间的鸿沟（Gap）。

### 2.4 终止机制的自主性

引入 `terminate` 工具调用，标志着模型具备了“自我评价”能力。模型不再是机械地执行固定轮数的修改，而是根据反馈判断目标是否达成，这体现了更高层次的智能决策。

---

## 3. 结论

`infer.py` 实现的流水线不仅是一个代码工具，更是一个探索 **Embodied AI** 在虚拟环境设计中应用的原型系统。它通过多模态反馈循环和结构化工具调用，展示了如何利用现有的基础模型（Foundation Models）构建复杂、精确且具备审美价值的 3D 空间生成方案。
